<script type="module">
    // --- DATABASE COM TREINOS COMPLETOS ---
    const database = {
        users: [
            { id: 1, name: 'André Brito', email: 'britodeandrade@gmail.com', photo: 'https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/WsTwhcQeE99iAkUHmCmn/pub/3Zy4n6ZmWp9DW98VtXpO.jpeg' },
            { id: 2, name: 'Marcelly Bispo', email: 'marcellybispo92@gmail.com', photo: 'https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/WsTwhcQeE99iAkUHmCmn/pub/2VWhNV4eSyDNkwEzPGvq.jpeg' },
            { id: 3, name: 'Marcia Brito', email: 'andrademarcia.ucam@gmail.com', photo: 'https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/WsTwhcQeE99iAkUHmCmn/pub/huS3I3wDTHbXGY1EuLjf.jpg' },
            { id: 4, name: 'Liliane Torres', email: 'lilicatorres@gmail.com', photo: 'https://i.ibb.co/7j6x0gG/liliane-torres.jpg' }
        ],
        
        trainingPlans: {
            'britodeandrade@gmail.com': {
                'A': [
                    { id: 1, name: 'Supino Reto', series: '4x10', carga: 70, img: 'https://via.placeholder.com/80x80/3b82f6/ffffff?text=SR', history: [] },
                    { id: 2, name: 'Agachamento Livre', series: '4x12', carga: 100, img: 'https://via.placeholder.com/80x80/10b981/ffffff?text=AL', history: [] },
                    { id: 3, name: 'Remada Curvada', series: '3x10', carga: 60, img: 'https://via.placeholder.com/80x80/f59e0b/ffffff?text=RC', history: [] },
                    { id: 4, name: 'Desenvolvimento', series: '3x12', carga: 40, img: 'https://via.placeholder.com/80x80/ef4444/ffffff?text=DV', history: [] }
                ],
                'B': [
                    { id: 1, name: 'Levantamento Terra', series: '4x8', carga: 120, img: 'https://via.placeholder.com/80x80/8b5cf6/ffffff?text=LT', history: [] },
                    { id: 2, name: 'Rosca Direta', series: '3x12', carga: 25, img: 'https://via.placeholder.com/80x80/06b6d4/ffffff?text=RD', history: [] },
                    { id: 3, name: 'Tríceps Testa', series: '3x15', carga: 30, img: 'https://via.placeholder.com/80x80/84cc16/ffffff?text=TT', history: [] },
                    { id: 4, name: 'Elevação Lateral', series: '3x15', carga: 12, img: 'https://via.placeholder.com/80x80/f97316/ffffff?text=EL', history: [] }
                ],
                'periodizacao': [
                    { week: "1ª e 2ª", phase: "Adaptação/Hipertrofia", methods: 'Método de execução Simples', reps: '10-12', volume: '16 séries/grupo', intensity: '70-75% 1RM', recovery: '60-90s' },
                    { week: "3ª e 4ª", phase: "Hipertrofia", methods: 'Bi-Set', reps: '8-10', volume: '18 séries/grupo', intensity: '75-80% 1RM', recovery: '45-60s' },
                    { week: "5ª e 6ª", phase: "Força/Hipertrofia", methods: 'Drop-Set', reps: '6-8', volume: '20 séries/grupo', intensity: '80-85% 1RM', recovery: '90-120s' }
                ],
                'attendance': {}
            },
            'marcellybispo92@gmail.com': {
                'A': [
                    { id: 1, name: 'Leg Press', series: '4x15', carga: 80, img: 'https://via.placeholder.com/80x80/3b82f6/ffffff?text=LP', history: [] },
                    { id: 2, name: 'Cadeira Extensora', series: '3x15', carga: 40, img: 'https://via.placeholder.com/80x80/10b981/ffffff?text=CE', history: [] },
                    { id: 3, name: 'Cadeira Flexora', series: '3x12', carga: 35, img: 'https://via.placeholder.com/80x80/f59e0b/ffffff?text=CF', history: [] }
                ],
                'B': [
                    { id: 1, name: 'Puxada Alta', series: '4x12', carga: 45, img: 'https://via.placeholder.com/80x80/8b5cf6/ffffff?text=PA', history: [] },
                    { id: 2, name: 'Remada Baixa', series: '3x12', carga: 50, img: 'https://via.placeholder.com/80x80/06b6d4/ffffff?text=RB', history: [] },
                    { id: 3, name: 'Rosca Scott', series: '3x15', carga: 15, img: 'https://via.placeholder.com/80x80/84cc16/ffffff?text=RS', history: [] }
                ],
                'periodizacao': [
                    { week: "1ª e 2ª", phase: "Adaptação", methods: 'Execução Controlada', reps: '12-15', volume: '12 séries/grupo', intensity: '60-65% 1RM', recovery: '90s' }
                ],
                'attendance': {}
            },
            'andrademarcia.ucam@gmail.com': {
                'A': [
                    { id: 1, name: 'Caminhada Esteira', series: '30min', carga: null, img: 'https://via.placeholder.com/80x80/3b82f6/ffffff?text=CE', history: [] },
                    { id: 2, name: 'Alongamento', series: '15min', carga: null, img: 'https://via.placeholder.com/80x80/10b981/ffffff?text=AL', history: [] }
                ],
                'B': [
                    { id: 1, name: 'Hidroginástica', series: '45min', carga: null, img: 'https://via.placeholder.com/80x80/8b5cf6/ffffff?text=HD', history: [] }
                ],
                'periodizacao': [
                    { week: "1ª a 4ª", phase: "Adaptação Cardio", methods: 'Atividade Contínua', reps: 'Leve', volume: '30-45min', intensity: '60% FC Max', recovery: 'Ativo' }
                ],
                'attendance': {}
            },
            'lilicatorres@gmail.com': {
                'A': [
                    { id: 1, name: 'Supino Máquina', series: '4x12', carga: 40, img: 'https://via.placeholder.com/80x80/3b82f6/ffffff?text=SM', history: [] },
                    { id: 2, name: 'Puxada Frente', series: '4x10', carga: 35, img: 'https://via.placeholder.com/80x80/10b981/ffffff?text=PF', history: [] }
                ],
                'B': [
                    { id: 1, name: 'Agachamento Smith', series: '4x10', carga: 50, img: 'https://via.placeholder.com/80x80/8b5cf6/ffffff?text=AS', history: [] },
                    { id: 2, name: 'Cadeira Adutora', series: '3x15', carga: 30, img: 'https://via.placeholder.com/80x80/06b6d4/ffffff?text=CA', history: [] }
                ],
                'periodizacao': [
                    { week: "1ª e 2ª", phase: "Base", methods: 'Máquinas Guiadas', reps: '10-12', volume: '14 séries/grupo', intensity: '65-70% 1RM', recovery: '75s' }
                ],
                'attendance': {}
            }
        },

        userRunningWorkouts: {
            'britodeandrade@gmail.com': [
                { method: 'FARTLEK', details: "5' AQ + 20' CO alternado entre CA : CO + 5' REC", speed: '8,5 Km/h', pace: '7:00/Km', time: '30 min', fcAlvo: '80%', fcMax: '184 BPM', fcTreino: '147,2 BPM' },
                { method: 'INTERVALADO', details: "5' AQ + (6 BLOCOS) 2' CO : 1'30'' REC + 3' REC", speed: '9,5 Km/h', pace: '6:19/Km', time: '30 min', fcAlvo: '85%', fcMax: '184 BPM', fcTreino: '156,4 BPM' }
            ],
            'marcellybispo92@gmail.com': [
                { method: 'FARTLEK', details: "5' AQ + 20' CO alternado entre CA : CO + 5' REC", speed: '7,5 Km/h', pace: '8:00/Km', time: '30 min', fcAlvo: '80%', fcMax: '187 BPM', fcTreino: '149,6 BPM' }
            ],
            'andrademarcia.ucam@gmail.com': [
                { method: 'CAMINHADA', details: "30' caminhada contínua em ritmo confortável", speed: '5,5 Km/h', pace: '11:00/Km', time: '30 min', fcAlvo: 'N/A', fcMax: '161 BPM', fcTreino: 'N/A' }
            ],
            'lilicatorres@gmail.com': [
                { method: 'FARTLEK', details: "5' CA Fraca + 25' CA Forte : CA Fraca", speed: '5,5 Km/h', pace: '11:00/Km', time: '30 min', fcAlvo: 'N/A', fcMax: '186 BPM', fcTreino: 'N/A' }
            ]
        }
    };

    // --- SISTEMA DE ARMAZENAMENTO ---
    const STORAGE_KEYS = {
        DATABASE: 'abfit_database',
        CURRENT_USER: 'abfit_current_user'
    };

    function initializeDatabase() {
        const savedDB = localStorage.getItem(STORAGE_KEYS.DATABASE);
        if (!savedDB) {
            localStorage.setItem(STORAGE_KEYS.DATABASE, JSON.stringify(database));
        }
    }

    function getDatabase() {
        const saved = localStorage.getItem(STORAGE_KEYS.DATABASE);
        return saved ? JSON.parse(saved) : database;
    }

    function saveDatabase(db) {
        localStorage.setItem(STORAGE_KEYS.DATABASE, JSON.stringify(db));
    }

    // --- STATE & NAVIGATION ---
    let currentStudentId = null;
    let currentStudentEmail = null;
    let isTransitioning = false;
    let currentTrainingType = null;
    let currentCalendarDate = new Date();

    function showScreen(targetId, direction = 'forward') {
        if (isTransitioning && direction !== 'none') return;
        isTransitioning = true;
        
        const currentScreen = document.querySelector('.screen.active');
        const targetScreen = document.getElementById(targetId);
        if (!targetScreen) { isTransitioning = false; return; }
        
        document.querySelectorAll('.screen').forEach(s => s.style.zIndex = '1');
        targetScreen.style.zIndex = '10';
        
        if (currentScreen && direction === 'none') {
             currentScreen.classList.remove('active');
             targetScreen.classList.add('active');
             isTransitioning = false;
             return;
        }

        if (currentScreen) { 
            currentScreen.classList.add(direction === 'forward' ? 'screen-exit-to-left' : 'screen-exit-to-right'); 
        }
        
        targetScreen.style.display = 'block'; 
        const enterClass = direction === 'forward' ? 'screen-enter-from-right' : 'screen-enter-from-left';
        targetScreen.classList.add(enterClass); 
        targetScreen.offsetHeight; 
        targetScreen.classList.remove(enterClass);
        targetScreen.classList.add('active'); 
        
        if (currentScreen) currentScreen.classList.remove('active');
        
        setTimeout(() => { 
            if (currentScreen) { 
                currentScreen.style.display = 'none'; 
                currentScreen.classList.remove('screen-exit-to-left', 'screen-exit-to-right'); 
            } 
            isTransitioning = false; 
        }, 500);
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO ---
    function populateUserSelection() {
        const container = document.getElementById('user-selection-container');
        container.innerHTML = database.users.map(user => `
            <div class="user-card flex items-center p-3 bg-gray-800 rounded-xl border border-gray-700 cursor-pointer hover:bg-gray-700 transition" data-user-email="${user.email}">
                <img src="${user.photo}" alt="${user.name}" class="w-12 h-12 rounded-full object-cover mr-4">
                <div class="flex-grow">
                    <p class="font-semibold text-white">${user.name}</p>
                    <span class="text-sm text-gray-400">Acessar meu perfil</span>
                </div>
                <i data-feather="log-in" class="text-red-500"></i>
            </div>
        `).join('');
        feather.replace();
    }

    function populateStudentList() {
        const container = document.getElementById('student-list-container');
        container.innerHTML = database.users.map(student => `
            <div class="student-card flex items-center p-3 bg-gray-800 rounded-xl border border-gray-700 cursor-pointer hover:bg-gray-700 transition" data-student-id="${student.id}">
                <img src="${student.photo}" alt="${student.name}" class="w-12 h-12 rounded-full object-cover mr-4">
                <div class="flex-grow">
                    <p class="font-semibold text-white">${student.name}</p>
                    <span class="text-sm text-gray-400">Ver perfil completo</span>
                </div>
                <i data-feather="user" class="text-blue-500"></i>
            </div>
        `).join('');
        feather.replace();
    }

    function populateStudentProfile(studentId) {
        currentStudentId = studentId;
        const student = database.users.find(s => s.id == studentId);
        if (!student) return;
        
        currentStudentEmail = student.email;
        const db = getDatabase();
        
        const infoContainer = document.getElementById('student-profile-info');
        infoContainer.innerHTML = `
            <img src="${student.photo}" alt="${student.name}" class="w-14 h-14 rounded-full object-cover mr-4">
            <div>
                <h2 class="text-xl font-bold text-white">${student.name}</h2>
                <p class="text-gray-400 text-sm">${student.email}</p>
            </div>
        `;

        const buttonsContainer = document.getElementById('student-profile-buttons');
        buttonsContainer.innerHTML = `
            <button class="profile-action-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="A">
                <i data-feather="star"></i><span class="text-xs">TREINO A</span>
            </button>
            <button class="profile-action-btn bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="B">
                <i data-feather="zap"></i><span class="text-xs">TREINO B</span>
            </button>
            <button class="profile-action-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="corrida">
                <i data-feather="trending-up"></i><span class="text-xs">CORRIDA</span>
            </button>
            <button class="profile-action-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="periodizacao">
                <i data-feather="calendar"></i><span class="text-xs">PERIODIZAÇÃO</span>
            </button>
            <button class="profile-action-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="evolution">
                <i data-feather="bar-chart-2"></i><span class="text-xs">PROGRESSO</span>
            </button>
            <button class="profile-action-btn bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="weight">
                <i data-feather="activity"></i><span class="text-xs">CONTROLE PESO</span>
            </button>
            <button class="profile-action-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 rounded-xl flex flex-col items-center justify-center space-y-2 transition shadow-lg" data-action="outdoor">
                <i data-feather="sun"></i><span class="text-xs">OUTDOOR</span>
            </button>
        `;
        
        feather.replace();
        renderCalendar();
    }

    // --- SISTEMA DE TREINOS ---
    function loadTrainingScreen(trainingType) {
        currentTrainingType = trainingType;
        const db = getDatabase();
        const trainingPlan = db.trainingPlans[currentStudentEmail]?.[trainingType] || [];
        
        const title = document.getElementById('training-title');
        const content = document.getElementById('training-content-wrapper');
        
        title.textContent = `Treino ${trainingType}`;
        content.innerHTML = '';

        if (trainingPlan.length === 0) {
            content.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                    <i data-feather="frown" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Nenhum treino cadastrado</h3>
                    <p class="text-gray-400">Entre em contato com o professor para definir seu treino.</p>
                </div>
            `;
            feather.replace();
            return;
        }

        trainingPlan.forEach((exercise, index) => {
            const exerciseCard = document.createElement('div');
            exerciseCard.className = 'bg-gray-800 p-4 rounded-xl border border-gray-700';
            exerciseCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <img src="${exercise.img}" alt="${exercise.name}" class="w-16 h-16 rounded-lg object-cover mr-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-white text-lg">${exercise.name}</h3>
                            <p class="text-gray-300 text-sm">${exercise.series}</p>
                            <div class="flex items-center mt-2">
                                <input type="number" 
                                       value="${exercise.carga || ''}" 
                                       class="carga-input w-20 bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 mr-2" 
                                       placeholder="Carga"
                                       data-exercise-id="${exercise.id}">
                                <span class="text-gray-300 text-sm">kg</span>
                                <button class="save-carga-btn ml-4 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-colors" data-exercise-id="${exercise.id}">
                                    Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="checkin-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors ml-4" data-exercise-id="${exercise.id}">
                        <i data-feather="check"></i>
                    </button>
                </div>
            `;
            content.appendChild(exerciseCard);
        });

        feather.replace();

        // Event listeners para os botões
        content.querySelectorAll('.save-carga-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const exerciseId = e.target.closest('.save-carga-btn').dataset.exerciseId;
                const input = content.querySelector(`.carga-input[data-exercise-id="${exerciseId}"]`);
                saveExerciseLoad(exerciseId, parseFloat(input.value));
            });
        });

        content.querySelectorAll('.checkin-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const exerciseId = e.target.closest('.checkin-btn').dataset.exerciseId;
                markExerciseAsCompleted(exerciseId);
            });
        });
    }

    function saveExerciseLoad(exerciseId, newCarga) {
        const db = getDatabase();
        const exercise = db.trainingPlans[currentStudentEmail]?.[currentTrainingType]?.find(ex => ex.id == exerciseId);
        
        if (exercise) {
            exercise.carga = newCarga;
            exercise.history.push({
                carga: newCarga,
                date: new Date().toISOString().split('T')[0]
            });
            saveDatabase(db);
            alert('Carga salva com sucesso!');
        }
    }

    function markExerciseAsCompleted(exerciseId) {
        const db = getDatabase();
        const today = new Date().toISOString().split('T')[0];
        
        if (!db.trainingPlans[currentStudentEmail].attendance) {
            db.trainingPlans[currentStudentEmail].attendance = {};
        }
        
        if (!db.trainingPlans[currentStudentEmail].attendance[today]) {
            db.trainingPlans[currentStudentEmail].attendance[today] = {
                type: currentTrainingType,
                exercises: []
            };
        }
        
        db.trainingPlans[currentStudentEmail].attendance[today].exercises.push(exerciseId);
        saveDatabase(db);
        
        alert('Exercício marcado como realizado!');
        renderCalendar();
    }

    // --- SISTEMA DE CORRIDA ---
    function loadRunningScreen() {
        const db = getDatabase();
        const runningWorkouts = db.userRunningWorkouts[currentStudentEmail] || [];
        
        const title = document.getElementById('training-title');
        const content = document.getElementById('training-content-wrapper');
        
        title.textContent = 'Treino de Corrida';
        content.innerHTML = '';

        if (runningWorkouts.length === 0) {
            content.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                    <i data-feather="frown" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Nenhum treino de corrida cadastrado</h3>
                    <p class="text-gray-400">Entre em contato com o professor para definir seus treinos de corrida.</p>
                </div>
            `;
            feather.replace();
            return;
        }

        runningWorkouts.forEach((workout, index) => {
            const methodClass = `running-title-${workout.method.toLowerCase()}`;
            const card = document.createElement('div');
            card.className = 'running-session-card bg-gray-800 p-4 rounded-xl border border-gray-700';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="${methodClass} font-bold text-lg">${workout.method}</h3>
                    <button class="checkin-btn bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded-lg transition-colors" data-workout-index="${index}">
                        <i data-feather="check" class="w-3 h-3"></i> Realizado
                    </button>
                </div>
                <p class="text-white mb-2"><strong>Detalhes:</strong> ${workout.details}</p>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><span class="text-gray-400">Velocidade:</span> <span class="text-white">${workout.speed}</span></div>
                    <div><span class="text-gray-400">Pace:</span> <span class="text-white">${workout.pace}</span></div>
                    <div><span class="text-gray-400">Tempo:</span> <span class="text-white">${workout.time}</span></div>
                    <div><span class="text-gray-400">FC Alvo:</span> <span class="text-white">${workout.fcAlvo}</span></div>
                </div>
            `;
            content.appendChild(card);
        });

        feather.replace();

        content.querySelectorAll('.checkin-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const workoutIndex = e.target.closest('.checkin-btn').dataset.workoutIndex;
                markRunningAsCompleted(workoutIndex);
            });
        });
    }

    function markRunningAsCompleted(workoutIndex) {
        const db = getDatabase();
        const today = new Date().toISOString().split('T')[0];
        
        if (!db.trainingPlans[currentStudentEmail].attendance) {
            db.trainingPlans[currentStudentEmail].attendance = {};
        }
        
        if (!db.trainingPlans[currentStudentEmail].attendance[today]) {
            db.trainingPlans[currentStudentEmail].attendance[today] = {
                type: 'running',
                workouts: []
            };
        }
        
        db.trainingPlans[currentStudentEmail].attendance[today].workouts.push(workoutIndex);
        saveDatabase(db);
        
        alert('Treino de corrida marcado como realizado!');
        renderCalendar();
    }

    // --- SISTEMA DE PERIODIZAÇÃO ---
    function loadPeriodizationScreen() {
        const db = getDatabase();
        const periodization = db.trainingPlans[currentStudentEmail]?.periodizacao || [];
        
        const title = document.getElementById('training-title');
        const content = document.getElementById('training-content-wrapper');
        
        title.textContent = 'Periodização';
        content.innerHTML = '';

        if (periodization.length === 0) {
            content.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                    <i data-feather="frown" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Periodização não definida</h3>
                    <p class="text-gray-400">Entre em contato com o professor para definir sua periodização.</p>
                </div>
            `;
            feather.replace();
            return;
        }

        periodization.forEach((phase, index) => {
            const phaseCard = document.createElement('div');
            phaseCard.className = 'bg-gray-800 p-4 rounded-xl border border-gray-700 mb-4';
            phaseCard.innerHTML = `
                <h3 class="font-bold text-white text-lg mb-3">${phase.week} - ${phase.phase}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div><span class="text-gray-400">Método:</span> <span class="text-white">${phase.methods}</span></div>
                    <div><span class="text-gray-400">Repetições:</span> <span class="text-white">${phase.reps}</span></div>
                    <div><span class="text-gray-400">Volume:</span> <span class="text-white">${phase.volume}</span></div>
                    <div><span class="text-gray-400">Intensidade:</span> <span class="text-white">${phase.intensity}</span></div>
                    <div><span class="text-gray-400">Recuperação:</span> <span class="text-white">${phase.recovery}</span></div>
                </div>
            `;
            content.appendChild(phaseCard);
        });

        feather.replace();
    }

    // --- SISTEMA DE CALENDÁRIO ---
    function renderCalendar() {
        const db = getDatabase();
        const attendance = db.trainingPlans[currentStudentEmail]?.attendance || {};
        
        const monthYear = document.getElementById('calendar-month-year');
        const grid = document.getElementById('calendar-grid');
        
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        monthYear.textContent = currentCalendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();
        
        grid.innerHTML = '';
        
        // Dias vazios no início
        for (let i = 0; i < startingDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            grid.appendChild(emptyDay);
        }
        
        // Dias do mês
        const today = new Date().toISOString().split('T')[0];
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayAttendance = attendance[dateStr];
            const isToday = dateStr === today;
            
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day ${isToday ? 'today' : ''} ${
                dayAttendance ? `has-treino treino-${dayAttendance.type === 'running' ? 'F' : dayAttendance.type}` : ''
            }`;
            dayElement.textContent = day;
            dayElement.title = dayAttendance ? `Treino ${dayAttendance.type} realizado` : 'Sem treino';
            
            if (dayAttendance) {
                dayElement.addEventListener('click', () => {
                    showAttendanceDetails(dateStr, dayAttendance);
                });
            }
            
            grid.appendChild(dayElement);
        }
    }

    function showAttendanceDetails(dateStr, attendance) {
        alert(`Treino realizado em ${new Date(dateStr).toLocaleDateString('pt-BR')}\nTipo: ${attendance.type.toUpperCase()}`);
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('click', (e) => {
        const userCard = e.target.closest('.user-card');
        if (userCard) {
            const userEmail = userCard.dataset.userEmail;
            const user = database.users.find(u => u.email === userEmail);
            if (user) {
                populateStudentProfile(user.id);
                showScreen('studentProfileScreen', 'forward');
            }
            return;
        }

        const studentCard = e.target.closest('.student-card');
        if (studentCard) {
            const studentId = studentCard.dataset.studentId;
            populateStudentProfile(studentId);
            showScreen('studentProfileScreen', 'forward');
            return;
        }

        const backBtn = e.target.closest('.back-btn');
        if (backBtn) {
            const target = backBtn.dataset.target;
            showScreen(target, 'back');
            return;
        }

        const navBtn = e.target.closest('.nav-btn');
        if (navBtn) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-red-500');
                btn.classList.add('text-gray-400', 'hover:text-white');
            });
            navBtn.classList.remove('text-gray-400', 'hover:text-white');
            navBtn.classList.add('text-red-500');
            const targetScreen = navBtn.dataset.target;
            if(targetScreen) showScreen(targetScreen, 'none');
            return;
        }

        const actionBtn = e.target.closest('.profile-action-btn');
        if (actionBtn) {
            const action = actionBtn.dataset.action;
            if (action === 'A' || action === 'B') {
                loadTrainingScreen(action);
                showScreen('trainingScreen', 'forward');
            } else if (action === 'corrida') {
                loadRunningScreen();
                showScreen('trainingScreen', 'forward');
            } else if (action === 'periodizacao') {
                loadPeriodizationScreen();
                showScreen('trainingScreen', 'forward');
            } else if (action === 'evolution') {
                showScreen('evolutionScreen', 'forward');
            } else if (action === 'weight') {
                showScreen('weightControlScreen', 'forward');
            } else if (action === 'outdoor') {
                showScreen('outdoorScreen', 'forward');
            }
            return;
        }

        const prevMonthBtn = e.target.closest('#prev-month-btn');
        if (prevMonthBtn) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
            return;
        }

        const nextMonthBtn = e.target.closest('#next-month-btn');
        if (nextMonthBtn) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
            return;
        }
    });

    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
        initializeDatabase();
        
        const splash = document.getElementById('splashScreen');
        const app = document.getElementById('appContainer');

        setTimeout(() => {
            splash.classList.add('fade-out');
            splash.addEventListener('transitionend', () => {
                splash.style.display = 'none';
                app.style.display = 'flex';
                app.classList.remove('hidden');
                
                populateUserSelection();
                populateStudentList();
                showScreen('loginScreen', 'none');
            }, { once: true });
        }, 1500);
    });
</script>
