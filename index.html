<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Club App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, getDocs, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, getDocs, updateDoc, serverTimestamp, orderBy
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050a14; color: #e0e0e0; }
        [x-cloak] { display: none !important; }
        .piece-white { fill: #ffffff; stroke: #333; stroke-width: 1.5; }
        .piece-black { fill: #2c2c2c; stroke: #ccc; stroke-width: 1.5; }
        .splash-screen {
            background-color: #050a14;
            cursor: pointer;
        }
    </style>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('chessClub', () => ({
                showSplash: true,
                db: null, auth: null, user: null, userId: null,
                activeTab: 'play',
                game: { players: { white: { name: 'Brancas', elo: '----' }, black: { name: 'Pretas', elo: '----' } }, time: { white: 0, black: 0 } },
                board: [],
                chess: new Chess(),
                gameId: null,
                playerColor: null,
                isOpponentTurn: false,
                gameStatus: 'Inicie um novo jogo.',
                selectedPiece: null,
                possibleMoves: [],
                pgnMoves: [],
                opponentId: '',
                invitation: null,
                promotion: { show: false, from: '', to: '' },
                gameTimer: null,
                newGameSettings: { mode: 'player', time: 10 },
                turmas: [
                    { nome: 'Turma 611', alunos: ["Yasmin Faquetin", "Davi Lucca Martins Pereira", "Theo Machado", "Heitor Velasco", "Isaque de Medeiros", "Maria Liz", "Davi Lucas", "Ana Clara", "Nicolas Ferreira", "Pietro Coutinho", "Miguel Roberto", "Bernardo Costa", "Yasmin da Silva Melo", "Yuri Nascimento", "Isabella Teixeira das Chagas", "Isadora Torres de Andrade", "Alice Caldeira de Lima", "Nicolly Marques"] },
                    { nome: 'Turma 612', alunos: ["Lorena Militão", "Thaylor Barros", "Davi Luiz", "Isaac de Oliveira", "Pérola de Souza", "João Gabriel", "Miguel Araújo", "Ana Beatriz", "Jamylle Marcelo de Moraes", "Talita Reis", "Maria Eduarda dos Santos Maciel", "Hadassa Gomes Travasso", "Daniele Pereira de Oliveira", "Carlos Alexandre"] },
                    { nome: 'Turma 613', alunos: ["Agatha Silva", "Alice do Nascimento", "Aysha Vitoria", "Davi Lucca Santos Mendonça", "Edgar de Carvalho Rodrigues", "Eduarda Moreira", "Emanuelly Menezes de Oliveira", "Ian Carlos da Silva Nascimento", "Jefferson Nery", "Jefferson Santos", "Joyce de Souza", "Kamilly Santos", "Lara Beatriz", "Laura de Oliveira", "Laura Vitoria", "Maria Alice", "Maria Clara", "Maria Fernanda", "Miguel da Silva", "Ruan Pablo", "Ryan da Conceição", "Samuel Carlos", "Théo Alves", "Victor Hugo"] },
                    { nome: 'Turma 621', alunos: ["Luiz Fellipe Silva Miranda", "Lincoln Lopes", "Émerson Menezes", "Pedro Nicolas da Silva", "Pedro Henrique da Conceição", "Yan Fonseca", "Arthur de Paula Carvalho", "João Pedro Fidélis da Silva", "Davi Lucas Ribeiro", "Esther da Silva"] },
                    { nome: 'Turma 622', alunos: ["Alice Victoria", "Ana Julia Goulart", "Anthony Gabriel", "Arthur Patrick da Silva Trindade", "Felipe Araújo", "Gabriel do Nascimento", "Giovanna Netto", "Guilherme Santos", "Hagata Guimarães", "Heitor Araújo"] },
                    { nome: 'Turma 623', alunos: ["Ana Heloiza Marcolina Porto", "Cauã Lanor", "Emilly da Silva", "Gabriella Sofia", "Henrique Siqueira", "Lucas Melo", "Maria Eduarda Costa", "Maria Roberta"] },
                ],
                attendance: {
                    "611": [
                        { "name": "Yasmin Faquetin", "lastStatus": "F" }, { "name": "Davi Lucca Martins Pereira", "lastStatus": "P" }, { "name": "Theo Machado", "lastStatus": "P" }, { "name": "Heitor Velasco", "lastStatus": "F" }, { "name": "Isaque de Medeiros", "lastStatus": "F" }, { "name": "Maria Liz", "lastStatus": "P" }, { "name": "Davi Lucas", "lastStatus": "P" }, { "name": "Ana Clara", "lastStatus": "P" }, { "name": "Nicolas Ferreira", "lastStatus": "F" }, { "name": "Pietro Coutinho", "lastStatus": "F" }, { "name": "Miguel Roberto", "lastStatus": "F" }, { "name": "Bernardo Costa", "lastStatus": "F" }, { "name": "Yasmin da Silva Melo", "lastStatus": "F" }, { "name": "Yuri Nascimento", "lastStatus": "P" }, { "name": "Isabella Teixeira das Chagas", "lastStatus": "P" }, { "name": "Isadora Torres de Andrade", "lastStatus": "P" }, { "name": "Alice Caldeira de Lima", "lastStatus": "P" }, { "name": "Nicolly Marques", "lastStatus": "F" }
                    ],
                    "612": [
                        { "name": "Lorena Militão", "lastStatus": "P" }, { "name": "Thaylor Barros", "lastStatus": "F" }, { "name": "Davi Luiz", "lastStatus": "P" }, { "name": "Isaac de Oliveira", "lastStatus": "P" }, { "name": "Pérola de Souza", "lastStatus": "F" }, { "name": "João Gabriel", "lastStatus": "P" }, { "name": "Miguel Araújo", "lastStatus": "P" }, { "name": "Ana Beatriz", "lastStatus": "P" }, { "name": "Jamylle Marcelo de Moraes", "lastStatus": "P" }, { "name": "Talita Reis", "lastStatus": "P" }, { "name": "Maria Eduarda dos Santos Maciel", "lastStatus": "P" }, { "name": "Hadassa Gomes Travasso", "lastStatus": "P" }, { "name": "Daniele Pereira de Oliveira", "lastStatus": "P" }, { "name": "Carlos Alexandre", "lastStatus": "F" }
                    ],
                    "613": [
                        { "name": "Agatha Silva", "lastStatus": "P" }, { "name": "Alice do Nascimento", "lastStatus": "P" }, { "name": "Aysha Vitoria", "lastStatus": "P" }, { "name": "Davi Lucca Santos Mendonça", "lastStatus": "F" }, { "name": "Edgar de Carvalho Rodrigues", "lastStatus": "P" }, { "name": "Eduarda Moreira", "lastStatus": "P" }, { "name": "Emanuelly Menezes de Oliveira", "lastStatus": "F" }, { "name": "Ian Carlos da Silva Nascimento", "lastStatus": "P" }, { "name": "Jefferson Nery", "lastStatus": "P" }, { "name": "Jefferson Santos", "lastStatus": "P" }, { "name": "Joyce de Souza", "lastStatus": "P" }, { "name": "Kamilly Santos", "lastStatus": "F" }, { "name": "Lara Beatriz", "lastStatus": "P" }, { "name": "Laura de Oliveira", "lastStatus": "F" }, { "name": "Laura Vitoria", "lastStatus": "F" }, { "name": "Maria Alice", "lastStatus": "P" }, { "name": "Maria Clara", "lastStatus": "F" }, { "name": "Maria Fernanda", "lastStatus": "P" }, { "name": "Miguel da Silva", "lastStatus": "F" }, { "name": "Ruan Pablo", "lastStatus": "P" }, { "name": "Ryan da Conceição", "lastStatus": "F" }, { "name": "Samuel Carlos", "lastStatus": "P" }, { "name": "Théo Alves", "lastStatus": "P" }, { "name": "Victor Hugo", "lastStatus": "P" }
                    ],
                    "621": [
                        { "name": "Luiz Fellipe Silva Miranda", "lastStatus": "P" }, { "name": "Lincoln Lopes", "lastStatus": "P" }, { "name": "Émerson Menezes", "lastStatus": "F" }, { "name": "Pedro Nicolas da Silva", "lastStatus": "F" }, { "name": "Pedro Henrique da Conceição", "lastStatus": "P" }, { "name": "Yan Fonseca", "lastStatus": "F" }, { "name": "Arthur de Paula Carvalho", "lastStatus": "P" }, { "name": "João Pedro Fidélis da Silva", "lastStatus": "F" }, { "name": "Davi Lucas Ribeiro", "lastStatus": "F" }, { "name": "Esther da Silva", "lastStatus": "F" }
                    ],
                    "622": [
                        { "name": "Alice Victoria", "lastStatus": "P" }, { "name": "Ana Julia Goulart", "lastStatus": "P" }, { "name": "Anthony Gabriel", "lastStatus": "P" }, { "name": "Arthur Patrick da Silva Trindade", "lastStatus": "F" }, { "name": "Felipe Araújo", "lastStatus": "F" }, { "name": "Gabriel do Nascimento", "lastStatus": "P" }, { "name": "Giovanna Netto", "lastStatus": "F" }, { "name": "Guilherme Santos", "lastStatus": "F" }, { "name": "Hagata Guimarães", "lastStatus": "F" }, { "name": "Heitor Araújo", "lastStatus": "F" }
                    ],
                    "623": [
                        { "name": "Ana Heloiza Marcolina Porto", "lastStatus": "P" }, { "name": "Cauã Lanor", "lastStatus": "F" }, { "name": "Emilly da Silva", "lastStatus": "F" }, { "name": "Gabriella Sofia", "lastStatus": "F" }, { "name": "Henrique Siqueira", "lastStatus": "F" }, { "name": "Lucas Melo", "lastStatus": "F" }, { "name": "Maria Eduarda Costa", "lastStatus": "F" }, { "name": "Maria Roberta", "lastStatus": "F" }
                    ]
                },
                currentAttendance: {},
                attendanceDate: new Date().toISOString().slice(0, 10),
                rankedPlayers: [],
                tournaments: [],
                newTournament: { name: '', date: ''},
                
                init() {
                    this.initializeBoard();
                    this.generateRankings();
                    this.initializeFirebase();
                },
                
                async initializeFirebase() {
                    // Firebase initialization logic...
                },

                get pgnNotationTable() {
                    const pairs = [];
                    for (let i = 0; i < this.pgnMoves.length; i += 2) {
                        pairs.push({ white: this.pgnMoves[i], black: this.pgnMoves[i + 1] || '' });
                    }
                    return pairs;
                },

                generateRankings(){
                    let allStudents = [];
                    Object.values(this.attendance).flat().forEach(aluno => {
                         allStudents.push({
                            id: aluno.name.toLowerCase().replace(/\s+/g, ''),
                            name: aluno.name,
                            elo: Math.floor(Math.random() * 800) + 800,
                            games: Math.floor(Math.random() * 100),
                            wins: Math.floor(Math.random() * 40),
                            losses: Math.floor(Math.random() * 40),
                            draws: Math.floor(Math.random() * 20),
                        });
                    });
                    
                    this.rankedPlayers = [...new Map(allStudents.map(item => [item.name, item])).values()]
                                        .sort((a,b) => b.elo - a.elo);
                },

                async createTournament() {
                    if (!this.newTournament.name || !this.newTournament.date) return;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const tournamentsRef = window.firebase.collection(this.db, 'artifacts', appId, 'public', 'data', 'tournaments');
                    await window.firebase.addDoc(tournamentsRef, {
                        name: this.newTournament.name,
                        date: this.newTournament.date,
                        createdAt: window.firebase.serverTimestamp()
                    });
                    this.newTournament = { name: '', date: '' };
                },

                listenForTournaments() {
                     if(!this.db) return;
                     const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                     const q = window.firebase.query(window.firebase.collection(this.db, 'artifacts', appId, 'public', 'data', 'tournaments'), window.firebase.orderBy('createdAt', 'desc'));
                     window.firebase.onSnapshot(q, (snapshot) => {
                        this.tournaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     });
                },
                
                startNewGame() {
                    this.chess = new Chess();
                    this.gameId = `local_${Date.now()}`;
                    this.playerColor = 'w';
                    this.game.time.white = this.newGameSettings.time * 60;
                    this.game.time.black = this.newGameSettings.time * 60;
                    if (this.newGameSettings.mode === 'computer') {
                        this.game.players.white.name = this.user?.displayName || 'Você';
                        this.game.players.black.name = 'Computador';
                    } else {
                        this.game.players.white.name = 'Jogador 1';
                        this.game.players.black.name = 'Jogador 2';
                    }
                    this.initializeBoard();
                    this.startGameTimer();
                },

                formatTime(seconds) {
                    if (seconds === null || isNaN(seconds)) return "00:00";
                    const min = Math.floor(seconds / 60);
                    const sec = seconds % 60;
                    return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                },

                startGameTimer() {
                    if (this.gameTimer) clearInterval(this.gameTimer);
                    this.gameTimer = setInterval(() => {
                        if(this.chess.isGameOver()) { clearInterval(this.gameTimer); return; }
                        const turn = this.chess.turn();
                        if (turn === 'w') { if(this.game.time.white > 0) this.game.time.white--; if(this.game.time.white <= 0) this.handleTimeout('w'); } 
                        else { if(this.game.time.black > 0) this.game.time.black--; if(this.game.time.black <= 0) this.handleTimeout('b'); }
                    }, 1000);
                },
                
                handleTimeout(player) {
                    clearInterval(this.gameTimer);
                    this.gameStatus = `Tempo esgotado! ${player === 'w' ? 'Pretas' : 'Brancas'} vencem.`;
                },
                
                computerMove() {
                    if (this.chess.isGameOver()) return;
                    this.isOpponentTurn = true;
                    setTimeout(() => {
                        const moves = this.chess.moves();
                        const move = moves[Math.floor(Math.random() * moves.length)];
                        this.chess.move(move);
                        this.isOpponentTurn = false;
                        this.initializeBoard();
                    }, 700);
                },
                
                initializeBoard() { const fen = this.chess.fen(); const boardData = fen.split(' ')[0]; const rows = boardData.split('/'); const newBoard = []; for (let i = 0; i < 8; i++) { const row = []; let fileIndex = 0; for (const char of rows[i]) { if (isNaN(char)) { const piece = this.fenToPiece(char); row.push({ rank: i, file: fileIndex, piece: piece }); fileIndex++; } else { for (let j = 0; j < parseInt(char); j++) { row.push({ rank: i, file: fileIndex, piece: null }); fileIndex++; } } } newBoard.push(row); } this.board = newBoard; this.updateGameStatus(); this.pgnMoves = this.chess.pgn().split(/\d+\./).filter(n => n).map(n => n.trim().split(' ')).flat().filter(s => s); },
                fenToPiece(fenChar) { const color = fenChar === fenChar.toUpperCase() ? 'w' : 'b'; const type = fenChar.toLowerCase(); return { type, color }; },
                async inviteToGame() { if (!this.opponentId || !this.userId || this.opponentId === this.userId) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; try { const newGameRef = window.firebase.doc(window.firebase.collection(this.db, 'artifacts', appId, 'public', 'data', 'games')); const newGameId = newGameRef.id; const gameData = { fen: new Chess().fen(), pgn: '', players: { white: this.userId, black: this.opponentId }, whiteName: this.user.displayName || 'Anônimo', turn: 'w', status: 'pending', time: this.newGameSettings.time * 60, createdAt: window.firebase.serverTimestamp() }; await window.firebase.setDoc(newGameRef, gameData); const invitationRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'invitations', this.opponentId); await window.firebase.setDoc(invitationRef, { from: this.userId, fromName: this.user.displayName || "Anônimo", gameId: newGameId }); this.joinGame(newGameId, 'w'); } catch(error) { console.error("Error creating game invitation: ", error); } },
                listenForInvitations() { if (this.invitationUnsubscribe) this.invitationUnsubscribe(); if (!this.userId || !this.db) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const invitationRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'invitations', this.userId); this.invitationUnsubscribe = window.firebase.onSnapshot(invitationRef, (doc) => { this.invitation = doc.exists() && doc.data().from ? doc.data() : null; }); },
                async acceptInvitation() { if (!this.invitation) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const gameRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'games', this.invitation.gameId); await window.firebase.updateDoc(gameRef, { status: 'active', blackName: this.user.displayName || 'Anônimo' }); this.joinGame(this.invitation.gameId, 'b'); const invitationRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'invitations', this.userId); await window.firebase.setDoc(invitationRef, {}); },
                async declineInvitation() { if (!this.invitation) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const invitationRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'invitations', this.userId); await window.firebase.setDoc(invitationRef, {}); },
                joinGame(gameId, color) { this.gameId = gameId; this.playerColor = color; this.activeTab = 'play'; this.listenForGameUpdates(); },
                listenForGameUpdates() { if (this.gameDocUnsubscribe) this.gameDocUnsubscribe(); if (!this.gameId) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const gameRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'games', this.gameId); this.gameDocUnsubscribe = window.firebase.onSnapshot(gameRef, (doc) => { if (doc.exists()) { const gameData = doc.data(); this.chess.load(gameData.fen); this.pgnMoves = this.chess.pgn().split(/\d+\./).filter(n => n).map(n => n.trim().split(' ')).flat().filter(s => s); this.game.players.white.name = gameData.whiteName || 'Brancas'; this.game.players.black.name = gameData.blackName || 'Pretas'; this.game.time.white = gameData.time; this.game.time.black = gameData.time; this.initializeBoard(); this.isOpponentTurn = (this.playerColor !== this.chess.turn()); if(!this.gameTimer && gameData.status === 'active') this.startGameTimer(); } }); },
                handleSquareClick(rank, file) {
                    const isLocalGame = this.gameId && this.gameId.startsWith('local_');
                    if (isLocalGame) {
                        const turn = this.chess.turn();
                        const canMove = (this.newGameSettings.mode === 'player') || (this.newGameSettings.mode === 'computer' && turn === 'w');
                        if (!canMove) return;

                        const algebraic = this.toAlgebraic(rank, file);
                        const square = this.board[rank][file];
                        
                        if (this.selectedPiece) {
                            const from = this.toAlgebraic(this.selectedPiece.rank, this.selectedPiece.file);
                            this.makeMove(from, algebraic);
                        } else if (square && square.piece && square.piece.color === turn) {
                            this.selectedPiece = { rank, file };
                            const moves = this.chess.moves({ square: algebraic, verbose: true });
                            this.possibleMoves = moves.map(move => this.fromAlgebraic(move.to));
                        }
                    } else { // Online game logic
                        if (this.isOpponentTurn) return;
                        const algebraic = this.toAlgebraic(rank, file);
                        const square = this.board[rank][file];
                        if (this.selectedPiece) {
                            const from = this.toAlgebraic(this.selectedPiece.rank, this.selectedPiece.file);
                             const piece = this.chess.get(from);
                             if (piece.type === 'p' && ((piece.color === 'w' && rank === 0) || (piece.color === 'b' && rank === 7))) {
                                this.promotion = { show: true, from, to: algebraic }; return;
                            }
                            this.makeMove(from, algebraic);
                        } else if (square && square.piece && square.piece.color === this.playerColor) {
                            this.selectedPiece = { rank, file };
                            const moves = this.chess.moves({ square: algebraic, verbose: true });
                            this.possibleMoves = moves.map(move => this.fromAlgebraic(move.to));
                        }
                    }
                },
                promotePawn(piece) { const { from, to } = this.promotion; this.makeMove(from, to, piece); this.promotion = { show: false, from: '', to: '' }; },
                async makeMove(from, to, promotion) { let move; try { move = this.chess.move({ from, to, promotion }); } catch(e) {} if (move) { if (this.gameId.startsWith('local_')) { this.initializeBoard(); if (this.newGameSettings.mode === 'computer' && this.chess.turn() === 'b') this.computerMove();} else if(this.gameId) { const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const gameRef = window.firebase.doc(this.db, 'artifacts', appId, 'public', 'data', 'games', this.gameId); await window.firebase.updateDoc(gameRef, { fen: this.chess.fen(), pgn: this.chess.pgn(), turn: this.chess.turn() }); } } this.selectedPiece = null; this.possibleMoves = []; this.updateGameStatus(); },
                updateGameStatus() { let status = ''; const turn = this.chess.turn() === 'w' ? 'Brancas' : 'Pretas'; if (this.chess.isCheckmate()) { status = `Xeque-mate! ${turn === 'Brancas' ? 'Pretas' : 'Brancas'} vencem.`; clearInterval(this.gameTimer); } else if (this.chess.isDraw()) { status = 'Empate!'; clearInterval(this.gameTimer); } else { status = `${turn} jogam.`; if (this.chess.isCheck()) { status += ` ${turn} estão em xeque.`; } } this.gameStatus = status; },
                toAlgebraic(rank, file) { return String.fromCharCode(97 + file) + (8 - rank); },
                fromAlgebraic(alg) { const file = alg.charCodeAt(0) - 97; const rank = 8 - parseInt(alg[1]); return { rank, file }; },
                isPossibleMove(rank, file) { return this.possibleMoves.some(move => move.rank === rank && move.file === file); },
                getPieceSVG(type, color) { const symbolId = {p: 'pawn', r: 'rook', n: 'knight', b: 'bishop', q: 'queen', k: 'king'}[type.toLowerCase()]; const svgClass = color === 'w' ? 'piece-white' : 'piece-black'; if (!symbolId) return ''; return `<svg class="w-full h-full" viewBox="0 0 45 45"><use href="#${symbolId}" class="${svgClass}"/></svg>`; }
            }));
        });
    </script>
</body>
</html>

